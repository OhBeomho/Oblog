<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Oblog</title>
		<link rel="stylesheet" href="css/main.css" />
		<link rel="stylesheet" href="css/read.css" />
		<!-- Fontawesome css for like, dislike button -->
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
			integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		/>
	</head>
	<body>
		<header>
			<nav>
				<a href="/" class="brand">Oblog</a>
				<div>
					<a href="/">블로그</a>
					<a href="/write">글쓰기</a>
					<a id="accountID">로그인된 ID: </a>
				</div>
			</nav>
		</header>
		<main>
			<h2 class="title"></h2>
			<hr />
			<div style="display: flex; justify-content: space-between">
				<div class="writer-id"></div>
				<div class="write-date"></div>
			</div>
			<div class="content"></div>
			<div class="likes">
				<button id="like"><i class="fas fa-thumbs-up"></i></button>
				<button id="dislike"><i class="fas fa-thumbs-down"></i></button>
			</div>
			<div class="buttons"><button onclick="location.href = '/'">홈으로</button></div>
			<div>
				<ul id="commentList"></ul>
				<form>
					<textarea name="content"></textarea><br />
					<button type="button" id="comment">댓글 달기</button>
				</form>
			</div>
		</main>
		<footer>
			Made by <b>OhBeomho</b><br />
			Source on <a href="https://github.com/OhBeomho/Oblog">Github</a>.
		</footer>

		<script src="js/request.js"></script>
		<script>
			const accountID = document.getElementById("accountID");
			const blogID = new URL(location.href).searchParams.get("id");
			let userID;

			const likeButton = document.getElementById("like");
			const dislikeButton = document.getElementById("dislike");
			const commentList = document.getElementById("commentList");

			const form = document.querySelector("form");
			const commentButton = document.getElementById("comment");

			commentButton.addEventListener("click", () => {
				const data = {
					content: new FormData(form).get("content"),
					blogID
				};

				request("POST", "/comment", data, (_response) => {
					alert("댓글을 달았습니다.");
					location.reload();
				});
			});

			likeButton.addEventListener("click", () => {
				const type = likeButton.classList.contains("active") ? "likeCancel" : "like";
				request("GET", `/likes?type=${type}&id=${blogID}`, {}, (_response) => {
					likeButton.classList.toggle("active");

					if (dislikeButton.classList.contains("active")) {
						dislikeButton.click();
					}

					location.reload();
				});
			});
			dislikeButton.addEventListener("click", () => {
				const type = dislikeButton.classList.contains("active") ? "dislikeCancel" : "dislike";
				request("GET", `/likes?type=${type}&id=${blogID}`, {}, (_response) => {
					dislikeButton.classList.toggle("active");

					if (likeButton.classList.contains("active")) {
						likeButton.click();
					}

					location.reload();
				});
			});

			window.addEventListener("load", () => {
				request("GET", "/getid", {}, (response) => {
					accountID.innerText += " " + response;
					userID = response;

					getBlog();
				});

				function getBlog() {
					request("POST", "/read", { id: blogID }, (response) => {
						const result = JSON.parse(response).result;

						if (result === "NOT_FOUND") {
							document.querySelector("main").innerText = "존재하지 않는 글입니다.";
							return;
						}

						const blog = result[0],
							comments = result[1];

						const { title, writerid, writedate, content, likeidarray, dislikeidarray } = blog;
						document.querySelector(".title").innerText = title;
						document.querySelector(".writer-id").innerText = writerid;
						document.querySelector(".write-date").innerText = writedate;
						document.querySelector(".content").innerText = content;

						if (likeidarray) {
							likeButton.innerHTML += " " + likeidarray.length;

							if (likeidarray.includes(userID)) {
								likeButton.classList.add("active");
							}
						} else {
							likeButton.innerHTML += " 0";
						}

						if (dislikeidarray) {
							dislikeButton.innerHTML += " " + dislikeidarray.length;

							if (dislikeidarray.includes(userID)) {
								dislikeButton.classList.add("active");
							}
						} else {
							dislikeButton.innerHTML += " 0";
						}

						if (userID === writerid) {
							const deleteBlogButton = document.createElement("button");
							deleteBlogButton.innerText = "글 삭제";
							deleteBlogButton.addEventListener("click", () => {
								if (confirm("정말로 이 글을 삭제하시겠습니까?")) {
									request("GET", "/deleteBlog?id=" + blogID, {}, (response) => {
										const result = JSON.parse(response).result;
	
										if (result === "NOT_FOUND") {
											alert("존재하지 않는 글입니다.");
										} else if (result === "NOT_OP") {
											alert("이 글의 작성자가 아닙니다.");
										} else if (result === "SUCCESS") {
											alert("글이 성공적으로 삭제되었습니다.");
											location.href = "/";
										}
									});
								}
							});

							const updateButton = document.createElement("button");
							updateButton.innerText = "글 수정";
							updateButton.addEventListener(
								"click",
								() => (location.href = "/write?update=" + result[0].id)
							);

							document.querySelector(".buttons").append(deleteBlogButton, updateButton);
						}

						if (comments) {
							for (let comment of comments) {
								addComment(comment);
							}
						}
					});
				}

				function addComment({ id, writerid, writedate, content }) {
					const comment = document.createElement("li");
					comment.className = "comment";
					comment.innerHTML = `
						<div class="top">
							<div class="profile">
								<svg
									version="1.1"
									id="Capa_1"
									xmlns="http://www.w3.org/2000/svg"
									xmlns:xlink="http://www.w3.org/1999/xlink"
									x="0px"
									y="0px"
									viewBox="0 0 60 60"
									width="30px"
									height="30px"
									fill="#000000"
									style="border-radius: 50%; padding: 5px; box-shadow: 0 0 0 1px black"
								>
									<ellipse style="fill: #010002" cx="30.336" cy="12.097" rx="11.997" ry="12.097" />
									<path
										style="fill: #010002"
										d="M35.64,30.079H25.031c-7.021,0-12.714,5.739-12.714,12.821v17.771h36.037V42.9
										C48.354,35.818,42.661,30.079,35.64,30.079z"
									/>
								</svg>
								<div class="c-writer-id">${writerid}</div>
							</div>
							<div class="c-write-date">${writedate}</div>
						</div>
						<button class="delete" style="float: right">삭제</button>
						<div class="c-content">${content}</div>
						<hr />
					`;

					commentList.appendChild(comment);

					const deleteButton = comment.querySelector(".delete");
					if (writerid === userID) {
						deleteButton.addEventListener("click", () =>
							request("GET", "/deleteComment?id=" + id, {}, (_response) => {
								alert("댓글을 삭제했습니다.");
								location.reload();
							})
						);
					} else {
						deleteButton.remove();
					}
				}
			});
		</script>
	</body>
</html>
